<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>PriceFinder</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="search-container">
    <ion-icon name="search" class="search-icon"></ion-icon>
    <ion-input 
      type="text" 
      placeholder="Search for products..." 
      class="search-input"
      (ionInput)="onSearch($event)"
      (keyup.enter)="performSearch(searchQuery)">
    </ion-input>
  </div>
  
  <div class="scan-button-container">
    <ion-button expand="block" size="large" (click)="goToScan()">
      <ion-icon name="scan" slot="start"></ion-icon>
      Scan Barcode
    </ion-button>
  </div>

  <!-- Comparateur de Prix -->
  <div class="price-comparison-section">
    <h5 class="section-title">Comparateur de Prix</h5>
    
    <!-- Message d'erreur -->
    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <!-- Résultats de recherche -->
    <div *ngIf="searchResults.length > 0" class="search-results">
      <h6>Produits trouvés ({{ searchResults.length }})</h6>
      
      <div class="search-product-list">
        <div 
          *ngFor="let product of searchResults" 
          class="search-product-item"
          (click)="comparePrices(product)"
          [class.selected]="selectedProduct?.id === product.id">
          
          <div class="search-product-image">
            <img 
              [src]="getProductImage(product)"
              [alt]="product.name"
              (error)="$event.target.src = 'assets/images/default-product.svg'">
          </div>
          
          <div class="search-product-info">
            <h6>{{ product.name }}</h6>
            <p *ngIf="product.description">{{ product.description }}</p>
            <p *ngIf="product.brand"><strong>Marque:</strong> {{ product.brand }}</p>
            <p><strong>Prix:</strong> {{ product.price }} {{ product.currency }}</p>
          </div>
          
          <ion-button fill="clear" size="small" (click)="comparePrices(product)">
            Comparer
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Comparaison de prix -->
    <div *ngIf="priceComparison && priceComparison.comparison_data" class="price-comparison">
      
      <!-- Produit sélectionné -->
      <div *ngIf="selectedProduct" class="selected-product">
        <h6>{{ selectedProduct.name }}</h6>
        <p *ngIf="selectedProduct.description">{{ selectedProduct.description }}</p>
        <p *ngIf="selectedProduct.brand"><strong>Marque:</strong> {{ selectedProduct.brand }}</p>
      </div>

      <!-- Résumé de la comparaison -->
      <div class="comparison-summary">
        <h6>Résumé de la Comparaison</h6>
        
        <div class="summary-grid">
          <div class="summary-item">
            <h6>Meilleur Prix</h6>
            <p class="price">{{ getBestPrice()?.price_amount }} {{ getBestPrice()?.price_currency }}</p>
            <small>{{ getBestPrice()?.store_info?.store_name }}</small>
          </div>
          
          <div class="summary-item">
            <h6>Prix le Plus Élevé</h6>
            <p class="price">{{ getPriceRange()?.max || 0 }} {{ priceComparison?.comparison_data?.[0]?.price_currency || 'XOF' }}</p>
          </div>
          
          <div *ngIf="calculateSavings()" class="summary-item">
            <h6>Économie Potentielle</h6>
            <p class="savings">{{ calculateSavings()?.amount || 0 }} {{ priceComparison?.comparison_data?.[0]?.price_currency || 'XOF' }}</p>
            <small>{{ calculateSavings()?.percentage || 0 }}%</small>
          </div>
        </div>
      </div>

      <!-- Détail des prix par magasin -->
      <div class="store-prices">
        <h6>Prix par Magasin ({{ priceComparison.comparison_data.length }})</h6>
        
        <div class="price-list">
          <div 
            *ngFor="let price of priceComparison.comparison_data; let i = index"
            class="price-item"
            [class.best-price]="i === 0">
            
            <div class="store-info">
              <h6>{{ price.store_info?.store_name || 'Magasin inconnu' }}</h6>
              <p *ngIf="price.store_info?.store_city">{{ price.store_info.store_city }}</p>
              <p *ngIf="price.store_info?.store_address">{{ price.store_info.store_address }}</p>
            </div>
            
            <div class="price-display">
              <span class="price-amount">{{ price.price_amount }}</span>
              <span class="price-currency">{{ price.price_currency }}</span>
              
              <div *ngIf="i === 0" class="best-price-badge">
                Meilleur Prix
              </div>
              
              <div *ngIf="price.price_is_promo" class="promo-badge">
                Promo
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- État de chargement -->
    <div *ngIf="isLoading" class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Chargement en cours...</p>
    </div>

    <!-- Recherches récentes -->
    <div *ngIf="recentSearches.length > 0 && !searchResults.length && !priceComparison" class="recent-searches">
      <h6>Recherches Récentes</h6>
      <div class="recent-tags">
        <ion-chip 
          *ngFor="let search of recentSearches" 
          (click)="performSearch(search)"
          color="primary">
          {{ search }}
        </ion-chip>
      </div>
    </div>
  </div>
  
  <h5 class="section-title">Popular Products</h5>
  <div class="product-grid">
    <div class="product-card" *ngFor="let product of popularProducts" (click)="showProductDetail(product)">
      <div class="position-relative">
        <div class="product-image">
          <ion-icon [name]="getProductIcon(product.image)" size="large"></ion-icon>
        </div>
        <div class="product-favorite" 
             [class.active]="isFavorite(product.id)"
             (click)="toggleFavorite($event, product.id)">
          <ion-icon name="heart"></ion-icon>
        </div>
      </div>
      <div class="product-info">
        <div class="product-title">{{ product.name }}</div>
        <div class="product-price">${{ product.price.toFixed(2) }}</div>
        <div class="product-seller">{{ product.seller }}</div>
      </div>
    </div>
  </div>
</ion-content>
